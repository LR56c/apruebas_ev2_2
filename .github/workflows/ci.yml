name: CI
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and run tests with Maven
        run: mvn clean package

      - name: Upload Surefire reports (JUnit)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: surefire-reports
          path: target/surefire-reports/

      - name: Upload BDD reports (Cucumber)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: bdd-reports
          path: target/cucumber-reports/

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Spring Boot app and k6 Performance Test
        run: |
          exit 1
          java -jar target/bdd-0.0.1-SNAPSHOT.jar &
           echo "Waiting for Spring Boot to be healthy..."
          n=0
          until [ "$n" -ge 12 ]
          do
             curl -fs http://localhost:8080/actuator/health && break
             n=$((n+1))
             echo "  (Still waiting... attempt $n)"
             sleep 5
          done
          if [ "$n" -ge 12 ]; then
             echo "Server did not start in 60s. Failing build."
             exit 1
          fi
          k6 run login-test.js --summary-export=k6-summary.json

      - name: Generate Job Summary Dashboard
        if: always()
        run: |
          LATENCY=$(jq -r '.metrics.http_req_duration."p(95)"' k6-summary.json || echo "0")ms
          TPS=$(jq -r '.metrics.http_reqs.rate' k6-summary.json || echo "0")/s
          ERRORS=$(jq -r '.metrics.http_req_failed.value' k6-summary.json || echo "0")%
          echo "## ðŸš€ Reporte de Performance (Login API)" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trica Clave | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Latencia (p95)** | $LATENCY |" >> $GITHUB_STEP_SUMMARY
          echo "| **TPS (Rendimiento)** | $TPS |" >> $GITHUB_STEP_SUMMARY


      - name: Send Notification on Failure
        if: failure()
        run: |
          echo "Â¡ALERTA! El Build ha fallado."
          echo "Revisar logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
