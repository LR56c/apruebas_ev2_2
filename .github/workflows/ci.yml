name: CI
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and run tests with Maven
        run: mvn clean package

      - name: Upload Surefire reports (JUnit)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: surefire-reports
          path: target/surefire-reports/

      - name: Upload BDD reports (Cucumber)
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: bdd-reports
          path: target/cucumber-reports/

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run Spring Boot app and k6 Performance Test
        run: |
          java -jar target/bdd-1.0-SNAPSHOT.jar &
          sleep 15
          k6 run login-test.js --summary-export=k6-summary.json

      - name: Generate Job Summary Dashboard
        if: always()
        run: |
          LATENCY=$(jq '.metrics."http_req_duration"."p(95)"' k6-summary.json)ms
          TPS=$(jq '.metrics."http_reqs"."rate"' k6-summary.json)/s
          ERRORS=$(jq '.metrics."http_req_failed"."rate"' k6-summary.json)%
          echo "## ðŸš€ Reporte de Performance (Login API)" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trica Clave | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Latencia (p95)** | $LATENCY |" >> $GITHUB_STEP_SUMMARY
          echo "| **TPS (Rendimiento)** | $TPS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tasa de Errores** | $ERRORS |" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack Notification on Failure
        if: failure()
        run: |
          echo "Â¡ALERTA! El Build ha fallado."
          echo "Revisar logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
